@using PerfumeStore.Application.Dtos.CartDtos

@model GetByIdCartDto


<style>
    .mini_cart {
        position: absolute;
        min-width: 355px;
        background: #fff;
        border: 1px solid #ebebeb;
        z-index: 999;
        right: 0;
        top: 142%;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.5s ease;
        padding: 0; /* default boş saxla */
    }

    .mini_cart_wrapper:hover .mini_cart {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        padding: 20px 28px 33px;
    }

    .close-btn {
        font-size: 20px;
        color: white;
    }

    .delete-btn{
        background:none;
        border:none;
        cursor: pointer;
    }

    .cart-link {
        position: relative;
        display: inline-block;
    }

        .cart-link i {
            font-size: 20px; /* ikon ölçüsü */
        }

    #cart-count {
        position: absolute;
        top: -2px; /* yuxarı çək */
        right: -10px; /* sağa çək */
        background: #00AFD5;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 50%;
        font-weight: bold;
    }

</style>
<a asp-controller="Cart" asp-action="Index" class="cart-link">
    <i class="fa fa-shopping-cart"></i>
    <span id="cart-count">@ViewBag.TotalQuantity</span>
</a>

<div class="mini_cart mini_cart2" style="background-color:#1e4a61;overflow-y:auto;max-height:400px">
    @if (Model?.CartItems != null)
    {
        @foreach (var item in Model.CartItems)
        {
            @if (item.ProductVariant != null)
            {
                <div class="cart_gallery">
                    <div class="cart_item">
                        <div class="cart_img"style="max-height:50%">
                            <a asp-controller="Kataloq" asp-action="Detail" asp-route-id="@item.ProductVariant.ProductId">
                                <img src="@item.ProductVariant.ProductImageUrl" alt="Perfume"loading="Lazy">
                            </a>
                        </div>
                        <div class="cart_info">
                            <a href="#">@item.ProductVariant.ProductName -@item.ProductVariant.Size</a>
                            <span>@item.Quantity x @item.ProductVariant.CurrentPrice.ToString("0.##") ₼</span>
                        </div>
                        <div class="cart_remove" id="cart-item-@item.CartItemId">
                            <form asp-controller="Cart" asp-action="DeletefromCartMenu" asp-route-id="@item.CartItemId" method="post" class="delete-form">
                                <button type="submit" class="delete-btn"><span class="close-btn">&times;</span></button>
                            </form>
                        </div>
                    </div>
                </div>
            }
          
        }

        <div class="mini_cart_table">
            <div class="cart_table_border">
                <div class="cart_total">
                    <span>Cəmi :</span>
                    <span class="price">@Model.TotalAmount</span> <!-- Burada toplam qiyməti dinamik et -->
                </div>
            </div>
        </div>
    }

    <div class="mini_cart_footer">
        <div class="cart_button">
            <a asp-controller="Cart" asp-action="Index">
                Səbətə bax
            </a>
        </div>
        <div class="cart_button">
            <a href="/Checkout">Sifariş et</a>
        </div>
    </div>
</div>
<script>
    document.querySelectorAll(".delete-form").forEach(form => {
        form.addEventListener("submit", function (e) {
            e.preventDefault(); // səhifə refresh olmasın

            fetch(form.action, {
                method: "POST"
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // HTML-dən məhsulu sil
                    form.closest(".cart_remove").remove();

                    // səbət sayını azalt (əgər icon varsa)
                    let count = document.getElementById("cart-count");
                    if (count) {
                        count.innerText = parseInt(count.innerText) - 1;
                    }

                    alert(data.message);
                    updateCartDropdown();
                } else {
                    alert("Xəta: " + data.message);
                }
            });
        });
    });
</script>

<script>
    window.updateCartDropdown = function () {
        $("#cartDropdownContainer").load("/Cart/RefreshCartDropdown");
    }
</script>